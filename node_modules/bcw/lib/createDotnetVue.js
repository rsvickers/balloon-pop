let fs = require("fs")
let { execSync } = require("child_process")
let { colors, startSpinner, stopSpinner } = require('../console-utils')
const { generateWorkspace } = require("./generateWorkspace")
const { npm_i } = require("./npm_i")

function createDotnetAuth(CURR_DIR, projectName) {
  return new Promise((resolve, reject) => {
    try {
      let projPath = `${CURR_DIR}/${projectName}`
      execSync(`npx create-project ${projectName} codeworks-templates/dotnet-webapi`)
      process.chdir(projPath)
      fs.renameSync(`${projPath}/{{name}}.csproj`, `${projPath}/${projectName}.csproj`)
      installServerDependencies()
      resolve(`[#] Open Project Workspace\n[#] cd into ${projectName}\n[#] type 'code ${projectName}.code-workspace`)
    } catch (e) {
      reject(e)
    }
  })
}

async function createDotnetFullstack(CURR_DIR, projectName, projectChoice = '') {
  return new Promise(async (resolve, reject) => {
    try {

      let framework = ''

      switch (projectChoice) {
        case 'dotnet-vue':
          framework = 'vue'
          break
        case 'dotnet-react':
          framework = 'react'
          break
        case 'dotnet-angular':
          framework = 'angular'
          break
      }


      let projPath = `${CURR_DIR}/${projectName}`
      fs.mkdirSync(projPath)
      process.chdir(projPath)

      await createDotnetAuth(projPath, projectName)
      process.chdir('../')
      execSync(`npx create-project ${projectName}.client codeworks-templates/${framework}-starter`)

      fs.writeFileSync(`${projPath}/${projectName}.code-workspace`, generateWorkspace(projectName, true), "utf8")

      installClientDependencies(projectName)
      resolve(`[#] Open Project Workspace\n[#] cd into ${projectName}\n[#] type 'code .`)
    } catch (e) {
      console.groupEnd()
      reject(e)
    }
  })
}

function addHerokuDeployWorkflow(projectName) {
 console.warn(' [!] DEPRECATED HEROKU DEPLOYMENT BE NO ACTION TAKEN')
}

function installClientDependencies(projectName) {
  process.chdir(`${projectName}.client`)
  npm_i()
  process.chdir(`../`)
}

function installServerDependencies() {
  console.groupCollapsed(colors.FgMagenta, "  [~] Installing Server Dependencies", colors.Reset)
  startSpinner()
  execSync('dotnet restore')
  stopSpinner()
  console.groupEnd()
}

exports.createDotnetFullstack = createDotnetFullstack
exports.createDotnetAuth = createDotnetAuth
