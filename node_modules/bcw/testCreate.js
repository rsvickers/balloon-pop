#!/usr/bin/env node
let fs = require("fs")
let slugify = require('slugify');
let inquirer = require("inquirer");
const { printAlert, clearScreen, colors, printWarning, printInfo, printSuccess } = require("./console-utils");
const { writeLog, initializeProject } = require("./utils");
const { execSync } = require("child_process");

const templates = [
  "mvc-auth"
];
const CURR_DIR = process.cwd();

//prompts and the name of properties added to the answers object
const prompts = [
  {
    name: "project-choice",
    type: "list",
    message: "What project template would you like to generate?",
    choices: templates
  },
  {
    name: "project-name",
    type: "input",
    message: "Project name:",
    validate(input) {
      return /^([A-Za-z\-\_\d])+$/.test(input)
        ? true
        : "Project name may only include letters, numbers, underscores and dashes.";
    }
  },
  {
    name: "initialize",
    type: "confirm",
    message: "Initialize git repository:"
  }
];

async function create() {
  // @ts-ignore
  const answers = await inquirer.prompt(prompts)
  let projectChoice = answers["project-choice"];
  let projectName = answers["project-name"];
  let initialize = answers["initialize"];
  // @ts-ignore
  projectName = slugify(projectName);
  try {
    clearScreen();
    console.group(colors.FgMagenta, "---INITIALIZING PROJECT---");
    printInfo(`--------------------\n[+] CREATING PROJECT\n[+] ${projectName}`);
    let message = ''
    switch (projectChoice) {
      case 'mvc-auth':
        let projPath = `${CURR_DIR}/${projectName}`;
        try {
          execSync(`npx create-project ${projectName} codeworks-templates/${projectChoice}#main`)
          process.chdir(projPath);
          execSync(`npx create-project template-tools codeworks-templates/template-tools#main`)

          fs.cpSync('template-tools/', './', { recursive: true })
          fs.rmSync('template-tools', { recursive: true, force: true })

        } catch (e) {
          console.error('[ERROR]', e)
        }
        break;
    }
    try {
      writeLog(`${CURR_DIR}\\${projectName}`, projectName)
    } catch (e) {
      console.warn('[~] Launch settings log file ', e.message)
    }
    printSuccess("[+] Project Created Successfully");
    printWarning(message);
    console.groupEnd();
    if (initialize) {
      initializeProject(projectName)
    }
  } catch (e) {
    printAlert(`[!] ${e.message}`, e);
  }
}

async function start() {
  try {
    await create()
  } catch (e) {
    console.error(e)
  }
}

start()


